<html ><head ><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title >How To Sign EIP-712 Structured Data With MetaMask</title><style >
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body ><article class="h-entry">
<header >
<h1 class="p-name">How To Sign EIP-712 Structured Data With MetaMask</h1>
</header>
<section data-field="subtitle" class="p-summary">
MetaMask is one of the most used crypto wallets, but it offers much more than that. With its help, we have the possibility to digitally…
</section>
<section data-field="body" class="e-content">
<section name="223e" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9656" id="9656" class="graf graf--h3 graf--leading graf--title">How To Sign EIP-712 Structured Data With MetaMask</h3><figure name="e902" id="e902" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*P5y6UcXGohQJHz-6" data-width="1024" data-height="1024" data-is-featured="true" src="/assets/0*P5y6UcXGohQJHz-6"></figure><p name="3774" id="3774" class="graf graf--p graf-after--figure"><a href="https://metamask.io/" data-href="https://metamask.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MetaMask</a> is one of the most used crypto wallets, but it offers much more than that. With its help, we have the possibility to digitally sign data structures, which can be utilized in many different ways. One option is to use MetaMask for authenticating our users. In this case, we identify our users with an Ethereum address instead of a password. The user proves ownership of the Ethereum address by digitally signing a data structure, and the signature is then validated on the server side. As MetaMask securely stores our private key and even offers the option to use hardware wallets, this type of authentication is much more secure than traditional password-based solutions.</p><p name="fac8" id="fac8" class="graf graf--p graf-after--p">There is also the option to sign certain API calls with MetaMask. For example, in the case of a financial service, in addition to MetaMask authentication, we can sign individual financial transactions separately, making them much more secure.</p><p name="3cbe" id="3cbe" class="graf graf--p graf-after--p">MetaMask signatures can be validated on the blockchain with the help of a smart contract. One area of use for this is metatransactions. With metatransactions, we can simplify the use of blockchain applications for users. In the case of metatransactions, the transaction fees are paid by a relay server instead of the user, so the user does not need to have cryptocurrency. The user simply puts together the transaction, signs it using MetaMask, and sends it to the relay server, which then forwards it to a smart contract. The smart contract validates the digital signature and executes the transaction.</p><p name="d26a" id="d26a" class="graf graf--p graf-after--p">After theory, let’s take a look at the practice.</p><p name="c8b0" id="c8b0" class="graf graf--p graf-after--p">The EIP-712 standard defines how to sign structured data packages in a standardized manner. MetaMask displays these structured data in a readable format for the user. An EIP-712 compliant structure, as shown on MetaMask (<a href="https://thebojda.github.io/karma_money/metatx_test.html" data-href="https://thebojda.github.io/karma_money/metatx_test.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">can be tested on this URL</a>) looks like this:</p><figure name="3167" id="3167" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*HJTcADwxenYTRYvC" data-width="384" data-height="425" src="/assets/0*HJTcADwxenYTRYvC"></figure><p name="cff5" id="cff5" class="graf graf--p graf-after--figure">The above transaction was generated using the following simple code:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="javascript" name="cdc6" id="cdc6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {<br ></br>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-property">isMetaMask</span>) {<br ></br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Please install MetaMask"</span>)<br ></br>        <span class="hljs-keyword">return</span><br ></br>      }<br ></br><br ></br>      <span class="hljs-keyword">const</span> accounts = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_requestAccounts'</span> });<br ></br>      <span class="hljs-keyword">const</span> chainId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_chainId'</span> });<br ></br>      <span class="hljs-keyword">const</span> eip712domain_type_definition = {<br ></br>        <span class="hljs-string">"EIP712Domain"</span>: [<br ></br>          {<br ></br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"name"</span>,<br ></br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span><br ></br>          },<br ></br>          {<br ></br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"version"</span>,<br ></br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span><br ></br>          },<br ></br>          {<br ></br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"chainId"</span>,<br ></br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span><br ></br>          },<br ></br>          {<br ></br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"verifyingContract"</span>,<br ></br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span><br ></br>          }<br ></br>        ]<br ></br>      }<br ></br>      <span class="hljs-keyword">const</span> karma_request_domain = {<br ></br>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"Karma Request"</span>,<br ></br>        <span class="hljs-string">"version"</span>: <span class="hljs-string">"1"</span>,<br ></br>        <span class="hljs-string">"chainId"</span>: chainId,<br ></br>        <span class="hljs-string">"verifyingContract"</span>: <span class="hljs-string">"0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"</span><br ></br>      }<br ></br><br ></br>      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'transfer_request'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {<br ></br>        <span class="hljs-keyword">const</span> transfer_request = {<br ></br>          <span class="hljs-string">"types"</span>: {<br ></br>            ...eip712domain_type_definition,<br ></br>            <span class="hljs-string">"TransferRequest"</span>: [<br ></br>              {<br ></br>                <span class="hljs-string">"name"</span>: <span class="hljs-string">"to"</span>,<br ></br>                <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span><br ></br>              },<br ></br>              {<br ></br>                <span class="hljs-string">"name"</span>: <span class="hljs-string">"amount"</span>,<br ></br>                <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span><br ></br>              }<br ></br>            ]<br ></br>          },<br ></br>          <span class="hljs-string">"primaryType"</span>: <span class="hljs-string">"TransferRequest"</span>,<br ></br>          <span class="hljs-string">"domain"</span>: karma_request_domain,<br ></br>          <span class="hljs-string">"message"</span>: {<br ></br>            <span class="hljs-string">"to"</span>: <span class="hljs-string">"0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"</span>,<br ></br>            <span class="hljs-string">"amount"</span>: <span class="hljs-number">1234</span><br ></br>          }<br ></br>        }<br ></br>        <span class="hljs-keyword">let</span> signature = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({<br ></br>          <span class="hljs-string">"method"</span>: <span class="hljs-string">"eth_signTypedData_v4"</span>,<br ></br>          <span class="hljs-string">"params"</span>: [<br ></br>            accounts[<span class="hljs-number">0</span>],<br ></br>            transfer_request<br ></br>          ]<br ></br>        })<br ></br>        <span class="hljs-title function_">alert</span>(<span class="hljs-string">"Signature: "</span> + signature)<br ></br>      })<br ></br>    }<br ></br>    <span class="hljs-title function_">main</span>()</span></pre><p name="d9cb" id="d9cb" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">eip712domain_type_definition</code> is a description of a general structure, which contains the metadata. The name field is the name of the structure, the version field is the definition version of the structure, and the chainId and verifyingContract fields determine which contract the message is intended for. The executing contract verifies this metadata in order to ensure that the signed transaction is only executed on the target contract.</p><p name="aa29" id="aa29" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">karma_request_domain</code> contains the specific value of the metadata defined by the EIP712Domain structure.</p><p name="5004" id="5004" class="graf graf--p graf-after--p">The actual structure that we send to MetaMask for signature is contained in the <code class="markup--code markup--p-code">transfer_request</code> variable. The types block contains the type definitions. Here, the first element is the mandatory EIP712Domain definition, which describes the metadata. This is followed by the actual structure definition, which in this case is the TransferRequest. This is the structure that will appear in MetaMask for the user. The domain block contains the specific value of the metadata, while the message contains the specific structure that we want to sign with the user.</p><p name="bef5" id="bef5" class="graf graf--p graf-after--p">The signature can be easily validated on the server side by using the <a href="https://www.npmjs.com/package/@metamask/eth-sig-util" data-href="https://www.npmjs.com/package/@metamask/eth-sig-util" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">eth-sig-util</a>:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="typescript" name="7b94" id="7b94" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> { recoverTypedSignature } <span class="hljs-keyword">from</span> <span class="hljs-string">'@metamask/eth-sig-util'</span><br ></br><br ></br><span class="hljs-keyword">const</span> address = <span class="hljs-title function_">recoverTypedSignature</span>({<br ></br>    <span class="hljs-attr">data</span>: typedData,<br ></br>    <span class="hljs-attr">signature</span>: signature,<br ></br>    <span class="hljs-attr">version</span>: <span class="hljs-title class_">SignTypedDataVersion</span>.<span class="hljs-property">V4</span><br ></br>}))</span></pre><p name="7b3c" id="7b3c" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">recoverTypedSignature</code> function has three parameters. The first parameter is the structured data, the second is the signature, and the last is the signature version. The return value of the function is the recovered Ethereum address.</p><p name="ec61" id="ec61" class="graf graf--p graf-after--p">Now, let’s see how the signature can be validated on-chain by a smart contract. The code is from my <a href="https://github.com/TheBojda/karma_money" data-href="https://github.com/TheBojda/karma_money" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">karma money repo</a> (you can read more about karma money <a href="https://betterprogramming.pub/karma-an-erc20-compatible-alternative-money-on-the-ethereum-blockchain-cee660b821ce" data-href="https://betterprogramming.pub/karma-an-erc20-compatible-alternative-money-on-the-ethereum-blockchain-cee660b821ce" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a>). The following TypeScript code sends a meta transaction to the karma money smart contract:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="typescript" name="0b48" id="0b48" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">const</span> types = {<br ></br>            <span class="hljs-string">"TransferRequest"</span>: [<br ></br>                {<br ></br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"from"</span>,<br ></br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span><br ></br>                },<br ></br>                {<br ></br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"to"</span>,<br ></br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span><br ></br>                },<br ></br>                {<br ></br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"amount"</span>,<br ></br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span><br ></br>                },<br ></br>                {<br ></br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"fee"</span>,<br ></br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span><br ></br>                },<br ></br>                {<br ></br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"nonce"</span>,<br ></br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span><br ></br>                }<br ></br>            ]<br ></br>        }<br ></br><br ></br><span class="hljs-keyword">let</span> nonce = <span class="hljs-keyword">await</span> contract.<span class="hljs-title function_">connect</span>(<span class="hljs-variable constant_">MINER</span>).<span class="hljs-title function_">getNonce</span>(<span class="hljs-variable constant_">ALICE</span>.<span class="hljs-property">address</span>)<br ></br><span class="hljs-keyword">const</span> message = {<br ></br>      <span class="hljs-string">"from"</span>: <span class="hljs-variable constant_">ALICE</span>.<span class="hljs-property">address</span>,<br ></br>      <span class="hljs-string">"to"</span>: <span class="hljs-variable constant_">JOHN</span>.<span class="hljs-property">address</span>,<br ></br>      <span class="hljs-string">"amount"</span>: <span class="hljs-number">10</span>,<br ></br>      <span class="hljs-string">"fee"</span>: <span class="hljs-number">1</span>,<br ></br>      <span class="hljs-string">"nonce"</span>: nonce<br ></br>}<br ></br><br ></br><span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">ALICE</span>.<span class="hljs-title function_">signTypedData</span>(karma_request_domain, <br ></br>   types, message)<br ></br><span class="hljs-keyword">await</span> contract.<span class="hljs-title function_">connect</span>(<span class="hljs-variable constant_">MINER</span>).<span class="hljs-title function_">metaTransfer</span>(<span class="hljs-variable constant_">ALICE</span>.<span class="hljs-property">address</span>, <span class="hljs-variable constant_">JOHN</span>.<span class="hljs-property">address</span>, <br ></br>   <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, nonce, signature)<br ></br>assert.<span class="hljs-title function_">equal</span>(<span class="hljs-keyword">await</span> contract.<span class="hljs-title function_">balanceOf</span>(<span class="hljs-variable constant_">ALICE</span>.<span class="hljs-property">address</span>), ethers.<span class="hljs-title function_">toBigInt</span>(<span class="hljs-number">11</span>))</span></pre><p name="8735" id="8735" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">types</code> variable defines the structure of the transaction. The “from” is the address of the sender, while the “to” is the address of the recipient. The amount represents the quantity of tokens to be transferred. The fee is the “amount” of tokens that we offer to the relay node in exchange for executing our transaction and covering the cost in the native currency of the chain. The “nonce” serves as a counter to ensure the uniqueness of the transaction. Without this field, a transaction could be executed multiple times. However, thanks to the nonce, a signed transaction can only be executed once.</p><p name="750c" id="750c" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">signTypedData</code> function provided by <a href="https://docs.ethers.org/v6/" data-href="https://docs.ethers.org/v6/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ethers.js</a> makes it easy to sign EIP-712 structures. It does the same thing as the code presented earlier but with a simpler usage.</p><p name="e436" id="e436" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">metaTransfer</code> is the method of the karma contract for executing meta-transaction.</p><p name="8d93" id="8d93" class="graf graf--p graf-after--p">Let’s see how it works:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="javascript" name="2035" id="2035" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">metaTransfer</span>(<span class="hljs-params"><br ></br>        address <span class="hljs-keyword">from</span>,<br ></br>        address to,<br ></br>        uint256 amount,<br ></br>        uint256 fee,<br ></br>        uint256 nonce,<br ></br>        bytes calldata signature<br ></br>    </span>) public virtual returns (bool) {<br ></br>        uint256 currentNonce = <span class="hljs-title function_">_useNonce</span>(<span class="hljs-keyword">from</span>, nonce);<br ></br>        (address recoveredAddress, <span class="hljs-variable constant_">ECDSA</span>.<span class="hljs-property">RecoverError</span> err) = <span class="hljs-variable constant_">ECDSA</span>.<span class="hljs-title function_">tryRecover</span>(<br ></br>            <span class="hljs-title function_">_hashTypedDataV4</span>(<br ></br>                <span class="hljs-title function_">keccak256</span>(<br ></br>                    abi.<span class="hljs-title function_">encode</span>(<br ></br>                        <span class="hljs-variable constant_">TRANSFER_REQUEST_TYPEHASH</span>,<br ></br>                        <span class="hljs-keyword">from</span>,<br ></br>                        to,<br ></br>                        amount,<br ></br>                        fee,<br ></br>                        currentNonce<br ></br>                    )<br ></br>                )<br ></br>            ),<br ></br>            signature<br ></br>        );<br ></br><br ></br>        <span class="hljs-built_in">require</span>(<br ></br>            err == <span class="hljs-variable constant_">ECDSA</span>.<span class="hljs-property">RecoverError</span>.<span class="hljs-property">NoError</span> && recoveredAddress == <span class="hljs-keyword">from</span>,<br ></br>            <span class="hljs-string">"Signature error"</span><br ></br>        );<br ></br><br ></br>        <span class="hljs-title function_">_transfer</span>(recoveredAddress, to, amount);<br ></br>        <span class="hljs-title function_">_transfer</span>(recoveredAddress, msg.<span class="hljs-property">sender</span>, fee);<br ></br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br ></br>    }</span></pre><p name="d6b3" id="d6b3" class="graf graf--p graf-after--pre">In order to validate the signature, we must first generate the hash of the structure. The exact steps for doing this are described in detail in the <a href="https://eips.ethereum.org/EIPS/eip-712" data-href="https://eips.ethereum.org/EIPS/eip-712" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">EIP-712 standard</a>, which includes a <a href="https://eips.ethereum.org/assets/eip-712/Example.sol" data-href="https://eips.ethereum.org/assets/eip-712/Example.sol" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">sample smart contract</a> and a <a href="https://eips.ethereum.org/assets/eip-712/Example.js" data-href="https://eips.ethereum.org/assets/eip-712/Example.js" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">sample javascript code</a>.</p><p name="c495" id="c495" class="graf graf--p graf-after--p">In summary, the essence is that we combine the TYPEHASH (which is the hash of the structure description) with the fields of the structure using <code class="markup--code markup--p-code">abi.encode</code>. Then produces a keccak256 hash. The hash is passed to the <code class="markup--code markup--p-code">_hashTypedDataV4</code> method, inherited from the EIP712 OpenZeppelin contract in the Karma contract. This function adds metadata to our structure and generates the final hash, making structure validation very simple and transparent. The outermost function is <code class="markup--code markup--p-code">ECDSA.tryRecover</code>, which attempts to recover the signer’s address from the hash and signature. If it matches the address of the “from“ parameter, the signature is valid. At the end of the code, the actual transaction is executed, and the relay node performing the transaction receives the fee.</p><p name="83fa" id="83fa" class="graf graf--p graf-after--p">EIP-712 is a general standard for signing structures, making it just one of many uses for implementing meta-transactions. As the signature can be validated not only with smart contracts, it can also be very useful in non-blockchain applications. For example, it can be used for server-side authentication, where the user identifies themselves with their private key. Such a system can provide a high level of security typically associated with cryptocurrencies, allowing for the possibility of using a web application only with a hardware key. In addition, individual API calls can also be signed with the help of MetaMask.</p><p name="618a" id="618a" class="graf graf--p graf-after--p graf--trailing">I hope that this brief overview of the EIP-712 standard has been inspiring for many and that you will be able to utilize it in both blockchain-based and non-blockchain projects.</p></div></div></section>
</section>
<footer ><p >By <a href="https://medium.com/@thebojda" class="p-author h-card">Laszlo Fazekas</a> on <a href="https://medium.com/p/35df217a1ab4"><time class="dt-published" datetime="2023-10-30T18:04:57.208Z">October 30, 2023</time></a>.</p><p ><a href="https://medium.com/@thebojda/how-to-sign-eip-712-structured-data-with-metamask-35df217a1ab4" class="p-canonical">Canonical link</a></p><p >Exported from <a href="https://medium.com">Medium</a> on December 27, 2023.</p></footer></article></body></html>